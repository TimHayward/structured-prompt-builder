<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Structured Prompt Builder</title>
    <link rel="icon" href="res/favicon.ico">
    <meta property="og:title" content="Structured Prompt Builder – AI Prompt Editor & Tester" />
    <meta name="description" content="Local AI prompt editor for JSON & Markdown. Build, run, and test prompts quickly. Supports OpenRouter & custom plug‑ins—ready for LLM integration Build, edit, and test AI prompts locally with a lightweight structured prompt builder. Supports JSON, Markdown, OpenRouter integration, plug‑in extensions.">
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://structured-prompt-builder.vercel.app/" />
    <meta property="og:image" content="https://structured-prompt-builder.vercel.app/res/og-image.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border: #e5e7eb;
            --accent: #2563eb;
            --accent-hover: #1d4ed8;
            --accent-light: #dbeafe;
            --radius: 12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.08);
        }

        [data-theme="dark-slate"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border: #334155;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --accent-light: #1e3a8a;
        }

        [data-theme="dark-midnight"] {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #171717;
            --text-primary: #fafafa;
            --text-secondary: #a3a3a3;
            --text-tertiary: #737373;
            --border: #262626;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --accent-light: #4c1d95;
        }

        [data-theme="light-warm"] {
            --bg-primary: #fffbeb;
            --bg-secondary: #fef3c7;
            --bg-tertiary: #fde68a;
            --text-primary: #78350f;
            --text-secondary: #92400e;
            --text-tertiary: #b45309;
            --border: #fbbf24;
            --accent: #f59e0b;
            --accent-hover: #d97706;
            --accent-light: #fef3c7;
        }

        [data-theme="light-cool"] {
            --bg-primary: #f0f9ff;
            --bg-secondary: #e0f2fe;
            --bg-tertiary: #bae6fd;
            --text-primary: #0c4a6e;
            --text-secondary: #075985;
            --text-tertiary: #0284c7;
            --border: #7dd3fc;
            --accent: #0ea5e9;
            --accent-hover: #0284c7;
            --accent-light: #e0f2fe;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-selector {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .theme-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .theme-btn:hover { transform: scale(1.1); }
        .theme-btn.active { box-shadow: 0 0 0 2px var(--accent); }

        .theme-btn-default { background: linear-gradient(135deg, #ffffff 50%, #1f2937 50%); }
        .theme-btn-slate { background: #1e293b; }
        .theme-btn-midnight { background: #000000; }
        .theme-btn-warm { background: #fef3c7; }
        .theme-btn-cool { background: #e0f2fe; }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .container { grid-template-columns: 1fr; }
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid var(--border);
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 1024px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .nav-actions {
                order: 2;
                justify-content: center;
            }

            .theme-selector {
                order: 3;
                justify-content: center;
            }

            .logo {
                justify-content: center;
            }
        }

        @media (max-width: 640px) {
            .nav-btn span:not(.icon) {
                display: none;
            }

            .nav-btn {
                padding: 0.5rem;
            }
        }

        .panel-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .nav-btn-primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .nav-btn-primary:hover {
            background: var(--accent-hover);
        }

        .form-group {
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9375rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        textarea.input {
            min-height: 120px;
            resize: vertical;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            border: none;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .list-item {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .list-item .input {
            flex: 1;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            transition: all 0.2s ease;
        }

        .tab:hover { background: var(--bg-tertiary); }
        .tab.active {
            color: var(--accent);
            background: var(--accent-light);
        }

        .editor {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            min-height: 500px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            color: var(--text-primary);
            overflow: auto;
            white-space: pre-wrap;
        }

        .editor[contenteditable="true"] {
            outline: none;
        }

        .editor[contenteditable="true"]:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .library-item {
            padding: 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }

        .library-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow);
        }

        .library-item-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .library-item-meta {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 0.75rem;
        }

        .model-select {
            position: relative;
        }

        select.input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%236b7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2.5rem;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            padding: 0.75rem;
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            color: #c00;
            font-size: 0.875rem;
            margin-top: 0.75rem;
        }

        .success {
            padding: 0.75rem;
            background: #efe;
            border: 1px solid #cfc;
            border-radius: 8px;
            color: #060;
            font-size: 0.875rem;
            margin-top: 0.75rem;
        }

        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .nav-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-btn:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
        }

        .nav-links {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-btn-icon:hover {
            background: var(--bg-tertiary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse-animation {
            animation: pulse 2s ease-in-out infinite;
        }

        .share-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem;
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 1000;
            display: none;
        }

        .share-menu.active {
            display: block;
            animation: slideIn 0.2s ease;
        }

        .share-item {
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s ease;
            color: var(--text-primary);
            text-decoration: none;
        }

        .share-item:hover {
            background: var(--bg-tertiary);
        }
    </style>
</head>
<body>
<header class="header">
    <div class="header-content">
        <a href="/" class="logo float-animation">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
            </svg>
            Structured Prompt Builder
        </a>

        <div class="nav-actions">
            <a href="changelog.html" class="nav-btn" title="Change Log">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
                Change Log
            </a>

            <a href="https://github.com/Siddhesh2377/structured-prompt-builder" target="_blank" rel="noopener" class="nav-btn" title="GitHub">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/>
                    <path d="M9 18c-4.51 2-5-2-7-2"/>
                </svg>
                GitHub
            </a>

            <a href="https://github.com/sponsors/Siddhesh2377" target="_blank" rel="noopener" class="nav-btn nav-btn-primary pulse-animation" title="Sponsor">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
                Sponsor
            </a>

            <div style="position: relative;">
                <button class="nav-btn-icon" id="shareBtn" title="Share">
                    <svg class="icon" viewBox="0 0 24 24">
                        <circle cx="18" cy="5" r="3"/>
                        <circle cx="6" cy="12" r="3"/>
                        <circle cx="18" cy="19" r="3"/>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                    </svg>
                </button>
                <div class="share-menu" id="shareMenu">
                    <a href="#" class="share-item" id="copyLink">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                        </svg>
                        Copy Link
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check%20out%20Structured%20Prompt%20Builder&url=https://structured-prompt-builder.vercel.app" target="_blank" class="share-item">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                            <path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"/>
                        </svg>
                        Share on X
                    </a>
                    <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://structured-prompt-builder.vercel.app" target="_blank" class="share-item">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                            <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
                            <rect x="2" y="9" width="4" height="12"/>
                            <circle cx="4" cy="4" r="2"/>
                        </svg>
                        Share on LinkedIn
                    </a>
                </div>
            </div>

            <button class="nav-btn-icon" id="bookmarkBtn" title="Bookmark">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                </svg>
            </button>
        </div>

        <div class="theme-selector">
            <button class="theme-btn theme-btn-default active" data-theme="default" title="Default"></button>
            <button class="theme-btn theme-btn-slate" data-theme="dark-slate" title="Dark Slate"></button>
            <button class="theme-btn theme-btn-midnight" data-theme="dark-midnight" title="Dark Midnight"></button>
            <button class="theme-btn theme-btn-warm" data-theme="light-warm" title="Light Warm"></button>
            <button class="theme-btn theme-btn-cool" data-theme="light-cool" title="Light Cool"></button>
        </div>
    </div>
</header>

<div class="container">
    <div class="panel">
        <h2 class="panel-title">Prompt Composition</h2>

        <div class="form-group">
            <label class="label">Title</label>
            <div style="display:flex; flex-direction:column; gap:0.5rem; align-items:stretch;">
                <select class="input" id="titleSelect">
                    <option value="custom">Free text (enter below)</option>
                </select>
                <input type="text" class="input" id="title" placeholder="Enter prompt title">
            </div>
        </div>

        <div class="form-group">
            <label class="label">Role</label>
            <div style="display:flex; flex-direction:column; gap:0.5rem; align-items:stretch;">
                <select class="input" id="roleSelect">
                    <option value="custom">Free text (enter below)</option>
                </select>
                <input type="text" class="input" id="role" placeholder="e.g., Expert AI Assistant">
            </div>
        </div>

        <div class="form-group">
            <label class="label">Task</label>
            <div style="display:flex; flex-direction:column; gap:0.5rem; align-items:stretch;">
                <select class="input" id="taskSelect">
                    <option value="custom">Free text (enter below)</option>
                </select>
                <textarea class="input" id="task" placeholder="Describe the main task"></textarea>
            </div>
        </div>

        <div class="form-group">
            <label class="label">Context</label>
            <div style="display:flex; flex-direction:column; gap:0.5rem; align-items:stretch;">
                <select class="input" id="contextSelect">
                    <option value="custom">Free text (enter below)</option>
                </select>
                <textarea class="input" id="context" placeholder="Additional context"></textarea>
            </div>
        </div>

        <div class="form-group">
            <div class="section-header" style="flex-direction:column; align-items:stretch;">
                <label class="label">Constraints</label>
                <div style="display:flex; gap:0.5rem; align-items:center; margin-top:0.5rem;">
                        <div style="display:flex; flex-direction:column; gap:0.5rem; align-items:stretch; width:100%;">
                            <select class="input" id="constraintSelect">
                                <option value="">Select external constraint</option>
                            </select>
                            <div style="display:flex; gap:0.5rem;">
                                <button class="btn btn-secondary" id="addConstraintFromSelect">Load</button>
                                <button class="btn btn-secondary" id="addConstraint">Add</button>
                            </div>
                        </div>
                </div>
            </div>
            <div id="constraintsList"></div>
        </div>

        <div class="form-group">
            <label class="label">Output Format</label>
            <div style="display:flex; flex-direction:column; gap:0.5rem; align-items:stretch;">
                <select class="input" id="outputFormatSelect">
                    <option value="custom">Free text (enter below)</option>
                </select>
                <textarea class="input" id="outputFormat" placeholder="Describe the desired output format"></textarea>
            </div>
        </div>

        <div class="form-group">
            <div class="section-header" style="flex-direction:column; align-items:stretch;">
                <label class="label">Examples</label>
                <div style="display:flex; gap:0.5rem; align-items:center; margin-top:0.5rem;">
                    <div style="display:flex; flex-direction:column; gap:0.5rem; align-items:stretch; width:100%;">
                        <select class="input" id="exampleSelect">
                            <option value="">Select external example</option>
                        </select>
                        <div style="display:flex; gap:0.5rem;">
                            <button class="btn btn-secondary" id="addExampleFromSelect">Load</button>
                            <button class="btn btn-secondary" id="addExample">Add</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="examplesList"></div>
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" id="savePrompt">Save to Library</button>
            <button class="btn btn-secondary" id="loadSample">Load Sample</button>
            <button class="btn btn-secondary" id="clearAll">Clear</button>
        </div>

        <div style="margin-top: 2rem;">
            <h3 class="panel-title">Library</h3>
            <div id="libraryList"></div>
        </div>
    </div>

    <div class="panel">
        <h2 class="panel-title">Preview & Test</h2>

        <div class="tabs">
            <button class="tab" data-editor="json">JSON</button>
            <button class="tab active" data-editor="markdown">Markdown</button>
            <button class="tab" data-editor="text">Plain Text</button>
        </div>

        <div class="editor" contenteditable="true" id="editor"></div>

        <div style="margin-top: 1.5rem;">
            <h3 class="panel-title">Test with AI</h3>

            <div class="form-group">
                <label class="label">OpenRouter API Key</label>
                <input type="password" class="input" id="apiKey" placeholder="Enter your OpenRouter API key">
            </div>

            <div class="form-group">
                <label class="label">Model</label>
                <div class="model-select">
                    <select class="input" id="modelSelect" disabled>
                        <option value="">Enter API key to load models</option>
                    </select>
                </div>
                <div id="modelLoading" style="display: none; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div class="loading"></div> Loading models...
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="label">Test Input</label>
                <textarea class="input" id="testInput" placeholder="Enter test input"></textarea>
            </div>

            <div id="advancedParams" style="display: none; animation: slideIn 0.3s ease;">
                <h3 class="panel-title" style="margin-top: 1.5rem;">Advanced Parameters</h3>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="label">Temperature (0-2)</label>
                        <input type="number" class="input" id="temperature" value="1.0" min="0" max="2" step="0.1">
                        <small style="color: var(--text-tertiary); font-size: 0.75rem;">Higher = more creative</small>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="label">Max Tokens</label>
                        <input type="number" class="input" id="maxTokens" value="2048" min="1" max="32000" step="1">
                        <small style="color: var(--text-tertiary); font-size: 0.75rem;">Maximum response length</small>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="label">Top P (0-1)</label>
                        <input type="number" class="input" id="topP" value="1.0" min="0" max="1" step="0.05">
                        <small style="color: var(--text-tertiary); font-size: 0.75rem;">Nucleus sampling</small>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="label">Top K</label>
                        <input type="number" class="input" id="topK" value="0" min="0" max="100" step="1">
                        <small style="color: var(--text-tertiary); font-size: 0.75rem;">0 = disabled</small>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="label">Frequency Penalty</label>
                        <input type="number" class="input" id="frequencyPenalty" value="0" min="-2" max="2" step="0.1">
                        <small style="color: var(--text-tertiary); font-size: 0.75rem;">Reduce repetition</small>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="label">Presence Penalty</label>
                        <input type="number" class="input" id="presencePenalty" value="0" min="-2" max="2" step="0.1">
                        <small style="color: var(--text-tertiary); font-size: 0.75rem;">Encourage new topics</small>
                    </div>
                </div>

                <div style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <label class="label" style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                        <input type="checkbox" id="streamEnabled" style="width: auto; margin: 0;">
                        Enable Streaming Response
                    </label>

                    <label class="label" style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                        <input type="checkbox" id="jsonMode" style="width: auto; margin: 0;">
                        JSON Mode (response_format)
                    </label>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 1rem;">
                <button class="btn btn-primary" id="testPrompt" disabled>Test Prompt</button>
                <button class="btn btn-secondary" id="toggleAdvanced">Advanced Settings</button>
            </div>

            <div id="testResult"></div>
        </div>
    </div>
</div>

<script>
    const state = {
        theme: localStorage.getItem('theme') || 'default',
        constraints: [],
        examples: [],
        currentEditor: 'markdown',
        library: JSON.parse(localStorage.getItem('promptLibrary') || '[]'),
        models: []
    };

    function populateTitleSelect() {
        const titleSelect = document.getElementById('titleSelect');
        if (!titleSelect) return;
        titleSelect.innerHTML = '';

        // Free-text option
        const freeOpt = document.createElement('option');
        freeOpt.value = 'custom';
        freeOpt.textContent = 'Free text (enter below)';
        titleSelect.appendChild(freeOpt);

        // External titles (from titles.json)
        if (Array.isArray(state.externalTitles) && state.externalTitles.length) {
            const group = document.createElement('optgroup');
            group.label = 'External Titles';
            state.externalTitles.forEach((t, i) => {
                const opt = document.createElement('option');
                // use a stable prefixed value so it doesn't collide with library ids
                opt.value = `ext-${i}`;
                opt.dataset.extIndex = String(i);
                opt.textContent = t.title || t;
                group.appendChild(opt);
            });
            titleSelect.appendChild(group);
        }

        // Saved library titles
        if (Array.isArray(state.library) && state.library.length) {
            const group = document.createElement('optgroup');
            group.label = 'Saved Prompts';
            state.library.forEach(p => {
                const opt = document.createElement('option');
                opt.value = String(p.id);
                opt.textContent = p.title;
                group.appendChild(opt);
            });
            titleSelect.appendChild(group);
        }
    }

    function populateRoleSelect() {
        const sel = document.getElementById('roleSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="custom">Free text (enter below)</option>';
        if (Array.isArray(state.externalRoles) && state.externalRoles.length) {
            state.externalRoles.forEach((r, i) => {
                const opt = document.createElement('option');
                opt.value = `ext-role-${i}`;
                opt.dataset.extIndex = String(i);
                opt.textContent = r.title || r;
                sel.appendChild(opt);
            });
        }
    }

    function populateTaskSelect() {
        const sel = document.getElementById('taskSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="custom">Free text (enter below)</option>';
        if (Array.isArray(state.externalTasks) && state.externalTasks.length) {
            state.externalTasks.forEach((t, i) => {
                const opt = document.createElement('option');
                opt.value = `ext-task-${i}`;
                opt.dataset.extIndex = String(i);
                opt.textContent = t.title || t;
                sel.appendChild(opt);
            });
        }
    }

    function populateContextSelect() {
        const sel = document.getElementById('contextSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="custom">Free text (enter below)</option>';
        if (Array.isArray(state.externalContexts) && state.externalContexts.length) {
            state.externalContexts.forEach((c, i) => {
                const opt = document.createElement('option');
                opt.value = `ext-context-${i}`;
                opt.dataset.extIndex = String(i);
                opt.textContent = c.title || c;
                sel.appendChild(opt);
            });
        }
    }

    function populateOutputFormatSelect() {
        const sel = document.getElementById('outputFormatSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="custom">Free text (enter below)</option>';
        if (Array.isArray(state.externalOutputFormats) && state.externalOutputFormats.length) {
            state.externalOutputFormats.forEach((f, i) => {
                const opt = document.createElement('option');
                opt.value = `ext-output-${i}`;
                opt.dataset.extIndex = String(i);
                opt.textContent = f;
                sel.appendChild(opt);
            });
        }
    }

    function populateConstraintsSelect() {
        const sel = document.getElementById('constraintSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="">Select external constraint</option>';
        if (Array.isArray(state.externalConstraints) && state.externalConstraints.length) {
            state.externalConstraints.forEach((c, i) => {
                const opt = document.createElement('option');
                opt.value = `ext-constraint-${i}`;
                opt.dataset.extIndex = String(i);
                opt.textContent = c;
                sel.appendChild(opt);
            });
        }
    }

    function populateExamplesSelect() {
        const sel = document.getElementById('exampleSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="">Select external example</option>';
        if (Array.isArray(state.externalExamples) && state.externalExamples.length) {
            state.externalExamples.forEach((e, i) => {
                const opt = document.createElement('option');
                opt.value = `ext-example-${i}`;
                opt.dataset.extIndex = String(i);
                opt.textContent = e;
                sel.appendChild(opt);
            });
        }
    }

    function formatRoleForOutput(role) {
        if (!role) return '';
        const trimmed = String(role).trim();
        const low = trimmed.toLowerCase();
        if (low.startsWith('you are')) return trimmed;
        return 'you are ' + trimmed;
    }

    async function loadExternalData(url = 'titles.json') {
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('Failed to fetch external data');
            const data = await res.json();

            state.externalTitles = (data.titles || []).map(item => typeof item === 'string' ? { id: item, title: item } : item);
            state.externalRoles = (data.roles || []).map(r => (typeof r === 'string' ? { title: r } : r));
            state.externalTasks = (data.tasks || []).map(t => (typeof t === 'string' ? { title: t } : t));
            state.externalContexts = (data.contexts || []).map(c => (typeof c === 'string' ? { title: c } : c));
            state.externalConstraints = (data.constraints || []).map(c => (typeof c === 'string' ? c : (c.title || String(c))));
            state.externalExamples = (data.examples || []).map(e => (typeof e === 'string' ? e : (e.title || String(e))));
            // optional output formats (look for several possible keys)
            const outputFormatsSource = data.output_formats || data.outputFormats || data.formats || data.output || [];
            state.externalOutputFormats = (outputFormatsSource || []).map(of => (typeof of === 'string' ? of : (of.title || String(of))));

            populateTitleSelect();
            populateRoleSelect();
            populateTaskSelect();
            populateContextSelect();
            populateConstraintsSelect();
            populateExamplesSelect();
            populateOutputFormatSelect();
        } catch (e) {
            console.warn('Could not load external data:', e);
        }
    }

    function init() {
        document.documentElement.setAttribute('data-theme', state.theme);
        document.querySelector(`[data-theme="${state.theme}"]`)?.classList.add('active');

        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                state.theme = btn.dataset.theme;
                localStorage.setItem('theme', state.theme);
                document.documentElement.setAttribute('data-theme', state.theme);
                document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                state.currentEditor = tab.dataset.editor;
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                updatePreview();
            });
        });

        document.getElementById('addConstraint').addEventListener('click', addConstraint);
        document.getElementById('addExample').addEventListener('click', addExample);
        document.getElementById('outputFormatSelect')?.addEventListener('change', (e) => {});
        document.getElementById('savePrompt').addEventListener('click', savePrompt);
        document.getElementById('loadSample').addEventListener('click', loadSamplePrompt);
        document.getElementById('clearAll').addEventListener('click', clearAll);
        document.getElementById('testPrompt').addEventListener('click', testPrompt);
        document.getElementById('toggleAdvanced').addEventListener('click', toggleAdvanced);

        // Title, role, task, context selects + free-text wiring
        // load external data (async) then populate; populate as fallback
        loadExternalData();
        populateTitleSelect();
        populateRoleSelect();
        populateTaskSelect();
        populateContextSelect();
        populateConstraintsSelect();
        populateExamplesSelect();
        populateOutputFormatSelect();

        const titleSelect = document.getElementById('titleSelect');
        const titleInput = document.getElementById('title');
        if (titleSelect) {
            titleSelect.addEventListener('change', (e) => {
                const v = e.target.value;
                if (v === 'custom') {
                    titleInput.disabled = false;
                    if (!titleInput.value) titleInput.value = '';
                    titleInput.focus();
                } else if (v && v.startsWith('ext-')) {
                    const idx = parseInt(e.target.selectedOptions[0].dataset.extIndex, 10);
                    const ext = state.externalTitles && state.externalTitles[idx];
                    titleInput.disabled = true;
                    titleInput.value = ext ? ext.title : '';
                } else {
                    const selected = state.library.find(p => String(p.id) === v);
                    titleInput.disabled = true;
                    titleInput.value = selected ? selected.title : '';
                }
                updatePreview();
            });
        }

        const roleSelect = document.getElementById('roleSelect');
        const roleInput = document.getElementById('role');
        if (roleSelect) {
            roleSelect.addEventListener('change', (e) => {
                const v = e.target.value;
                if (v === 'custom') {
                    roleInput.disabled = false;
                    if (!roleInput.value) roleInput.value = '';
                    roleInput.focus();
                } else if (v && v.startsWith('ext-role-')) {
                    const idx = parseInt(e.target.selectedOptions[0].dataset.extIndex, 10);
                    const ext = state.externalRoles && state.externalRoles[idx];
                    roleInput.disabled = true;
                    roleInput.value = ext ? (ext.title || ext) : '';
                }
                updatePreview();
            });
        }

        const taskSelect = document.getElementById('taskSelect');
        const taskInput = document.getElementById('task');
        if (taskSelect) {
            taskSelect.addEventListener('change', (e) => {
                const v = e.target.value;
                if (v === 'custom') {
                    taskInput.disabled = false;
                    if (!taskInput.value) taskInput.value = '';
                    taskInput.focus();
                } else if (v && v.startsWith('ext-task-')) {
                    const idx = parseInt(e.target.selectedOptions[0].dataset.extIndex, 10);
                    const ext = state.externalTasks && state.externalTasks[idx];
                    taskInput.disabled = true;
                    taskInput.value = ext ? (ext.title || ext) : '';
                }
                updatePreview();
            });
        }

        const contextSelect = document.getElementById('contextSelect');
        const contextInput = document.getElementById('context');
        if (contextSelect) {
            contextSelect.addEventListener('change', (e) => {
                const v = e.target.value;
                if (v === 'custom') {
                    contextInput.disabled = false;
                    if (!contextInput.value) contextInput.value = '';
                    contextInput.focus();
                } else if (v && v.startsWith('ext-context-')) {
                    const idx = parseInt(e.target.selectedOptions[0].dataset.extIndex, 10);
                    const ext = state.externalContexts && state.externalContexts[idx];
                    contextInput.disabled = true;
                    contextInput.value = ext ? (ext.title || ext) : '';
                }
                updatePreview();
            });
        }

        const outputSelect = document.getElementById('outputFormatSelect');
        const outputInput = document.getElementById('outputFormat');
        if (outputSelect) {
            outputSelect.addEventListener('change', (e) => {
                const v = e.target.value;
                if (v === 'custom') {
                    outputInput.disabled = false;
                    if (!outputInput.value) outputInput.value = '';
                    outputInput.focus();
                } else if (v && v.startsWith('ext-output-')) {
                    const idx = parseInt(e.target.selectedOptions[0].dataset.extIndex, 10);
                    const ext = state.externalOutputFormats && state.externalOutputFormats[idx];
                    outputInput.disabled = true;
                    outputInput.value = ext ? ext : '';
                }
                updatePreview();
            });
        }

        // Add-from-select handlers for constraints/examples
        const addConstraintFromSelectBtn = document.getElementById('addConstraintFromSelect');
        if (addConstraintFromSelectBtn) {
            addConstraintFromSelectBtn.addEventListener('click', () => {
                const sel = document.getElementById('constraintSelect');
                if (!sel) return;
                const v = sel.value;
                if (v && v.startsWith('ext-constraint-')) {
                    const idx = parseInt(sel.selectedOptions[0].dataset.extIndex, 10);
                    const text = state.externalConstraints && state.externalConstraints[idx];
                    if (text) {
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.innerHTML = `\n                                <input type="text" class="input" value="${text}">\n                                <button class="icon-btn" onclick="this.parentElement.remove(); updatePreview()">×</button>\n                            `;
                        div.querySelector('input').addEventListener('input', updatePreview);
                        document.getElementById('constraintsList').appendChild(div);
                        updatePreview();
                    }
                }
            });
        }

        const addExampleFromSelectBtn = document.getElementById('addExampleFromSelect');
        if (addExampleFromSelectBtn) {
            addExampleFromSelectBtn.addEventListener('click', () => {
                const sel = document.getElementById('exampleSelect');
                if (!sel) return;
                const v = sel.value;
                if (v && v.startsWith('ext-example-')) {
                    const idx = parseInt(sel.selectedOptions[0].dataset.extIndex, 10);
                    const text = state.externalExamples && state.externalExamples[idx];
                    if (text) {
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.innerHTML = `\n                                <input type="text" class="input" value="${text}">\n                                <button class="icon-btn" onclick="this.parentElement.remove(); updatePreview()">×</button>\n                            `;
                        div.querySelector('input').addEventListener('input', updatePreview);
                        document.getElementById('examplesList').appendChild(div);
                        updatePreview();
                    }
                }
            });
        }

        document.getElementById('shareBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('shareMenu').classList.toggle('active');
        });

        document.getElementById('copyLink').addEventListener('click', (e) => {
            e.preventDefault();
            navigator.clipboard.writeText(window.location.href);
            const item = e.currentTarget;
            const originalText = item.innerHTML;
            item.innerHTML = `
            <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
            Copied!
        `;
            setTimeout(() => {
                item.innerHTML = originalText;
                document.getElementById('shareMenu').classList.remove('active');
            }, 1500);
        });

        document.getElementById('bookmarkBtn').addEventListener('click', () => {
            if (window.sidebar && window.sidebar.addPanel) {
                window.sidebar.addPanel(document.title, window.location.href, '');
            } else if (window.external && ('AddFavorite' in window.external)) {
                window.external.AddFavorite(window.location.href, document.title);
            } else {
                alert('Press ' + (navigator.userAgent.toLowerCase().indexOf('mac') != -1 ? 'Cmd' : 'Ctrl') + '+D to bookmark this page.');
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#shareBtn') && !e.target.closest('#shareMenu')) {
                document.getElementById('shareMenu').classList.remove('active');
            }
        });

        const apiKeyInput = document.getElementById('apiKey');
        const savedKey = localStorage.getItem('openrouter_api_key');
        if (savedKey) {
            apiKeyInput.value = savedKey;
            fetchModels(savedKey);
        }

        apiKeyInput.addEventListener('blur', async (e) => {
            const key = e.target.value.trim();
            if (key) {
                localStorage.setItem('openrouter_api_key', key);
                await fetchModels(key);
            } else {
                localStorage.removeItem('openrouter_api_key');
                disableTestControls();
            }
        });

        ['title', 'role', 'task', 'context'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });
        document.getElementById('outputFormat')?.addEventListener('input', updatePreview);

        // also ensure constraint/example add buttons exist
        document.getElementById('addConstraintFromSelect')?.addEventListener('click', (e) => e.preventDefault());
        document.getElementById('addExampleFromSelect')?.addEventListener('click', (e) => e.preventDefault());

        renderLibrary();
        updatePreview();

        // Keep titleSelect in sync if library already has entries
        populateTitleSelect();
    }

    function toggleAdvanced() {
        const params = document.getElementById('advancedParams');
        const btn = document.getElementById('toggleAdvanced');
        if (params.style.display === 'none') {
            params.style.display = 'block';
            btn.textContent = 'Hide Advanced';
        } else {
            params.style.display = 'none';
            btn.textContent = 'Advanced Settings';
        }
    }

    function disableTestControls() {
        document.getElementById('modelSelect').disabled = true;
        document.getElementById('modelSelect').innerHTML = '<option value="">Enter API key to load models</option>';
        document.getElementById('testPrompt').disabled = true;
    }

    function enableTestControls() {
        document.getElementById('testPrompt').disabled = false;
    }

    async function fetchModels(apiKey) {
        const modelSelect = document.getElementById('modelSelect');
        const loadingDiv = document.getElementById('modelLoading');

        loadingDiv.style.display = 'block';
        modelSelect.disabled = true;

        try {
            const response = await fetch('https://openrouter.ai/api/v1/models', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'Structured Prompt Builder'
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch models');
            }

            const data = await response.json();
            state.models = data.data || [];

            const popularModels = [
                'anthropic/claude-3.5-sonnet',
                'anthropic/claude-3-opus',
                'openai/gpt-4o',
                'openai/gpt-4-turbo',
                'google/gemini-pro-1.5',
                'meta-llama/llama-3.1-70b-instruct',
                'mistralai/mistral-large'
            ];

            modelSelect.innerHTML = '<optgroup label="Popular Models">';

            popularModels.forEach(modelId => {
                const model = state.models.find(m => m.id === modelId);
                if (model) {
                    modelSelect.innerHTML += `<option value="${model.id}">${model.name || model.id}</option>`;
                }
            });

            modelSelect.innerHTML += '</optgroup><optgroup label="All Models">';

            state.models
                .filter(m => !popularModels.includes(m.id))
                .sort((a, b) => (a.name || a.id).localeCompare(b.name || b.id))
                .forEach(model => {
                    modelSelect.innerHTML += `<option value="${model.id}">${model.name || model.id}</option>`;
                });

            modelSelect.innerHTML += '</optgroup>';
            modelSelect.disabled = false;
            loadingDiv.style.display = 'none';
            enableTestControls();

        } catch (error) {
            modelSelect.innerHTML = '<option value="">Error loading models - check API key</option>';
            loadingDiv.style.display = 'none';
            disableTestControls();
            console.error('Error fetching models:', error);
        }
    }

    function addConstraint() {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
                <input type="text" class="input" placeholder="Enter constraint">
                <button class="icon-btn" onclick="this.parentElement.remove(); updatePreview()">×</button>
            `;
        div.querySelector('input').addEventListener('input', updatePreview);
        document.getElementById('constraintsList').appendChild(div);
    }

    function addExample() {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
                <input type="text" class="input" placeholder="Enter example">
                <button class="icon-btn" onclick="this.parentElement.remove(); updatePreview()">×</button>
            `;
        div.querySelector('input').addEventListener('input', updatePreview);
        document.getElementById('examplesList').appendChild(div);
    }

    function getPromptData() {
        const constraints = Array.from(document.querySelectorAll('#constraintsList input'))
            .map(i => i.value).filter(Boolean);
        const examples = Array.from(document.querySelectorAll('#examplesList input'))
            .map(i => i.value).filter(Boolean);

        return {
            title: document.getElementById('title').value,
            role: document.getElementById('role').value,
            task: document.getElementById('task').value,
            context: document.getElementById('context').value,
            outputFormat: document.getElementById('outputFormat') ? document.getElementById('outputFormat').value : '',
            constraints,
            examples
        };
    }

    function updatePreview() {
        const data = getPromptData();
        const editor = document.getElementById('editor');
        if (state.currentEditor === 'json') {
            const out = Object.assign({}, data);
            out.role = data.role ? formatRoleForOutput(data.role) : data.role;
            out.outputFormat = data.outputFormat || '';
            editor.textContent = JSON.stringify(out, null, 2);
        } else if (state.currentEditor === 'markdown') {
            let md = `# ${data.title || 'Untitled Prompt'}\n\n`;
            if (data.role) md += `**Role:** ${formatRoleForOutput(data.role)}\n\n`;
            if (data.task) md += `**Task:** ${data.task}\n\n`;
            if (data.context) md += `**Context:** ${data.context}\n\n`;
            if (data.outputFormat) md += `**Output Format:** ${data.outputFormat}\n\n`;
            if (data.constraints.length) {
                md += `**Constraints:**\n${data.constraints.map(c => `- ${c}`).join('\n')}\n\n`;
            }
            if (data.examples.length) {
                md += `**Examples:**\n${data.examples.map(e => `- ${e}`).join('\n')}\n`;
            }
            editor.textContent = md;
        } else {
            let text = data.title ? `${data.title}\n\n` : '';
            if (data.role) text += `Role: ${formatRoleForOutput(data.role)}\n`;
            if (data.task) text += `Task: ${data.task}\n`;
            if (data.context) text += `Context: ${data.context}\n`;
            if (data.outputFormat) text += `Output Format: ${data.outputFormat}\n`;
            if (data.constraints.length) {
                text += `\nConstraints:\n${data.constraints.map((c, i) => `${i + 1}. ${c}`).join('\n')}\n`;
            }
            if (data.examples.length) {
                text += `\nExamples:\n${data.examples.join('\n')}\n`;
            }
            editor.textContent = text;
        }
    }

    function savePrompt() {
        const data = getPromptData();
        if (!data.title) {
            alert('Please enter a title');
            return;
        }

        const prompt = {
            id: Date.now(),
            ...data,
            timestamp: new Date().toISOString()
        };

        state.library.unshift(prompt);
        localStorage.setItem('promptLibrary', JSON.stringify(state.library));
        renderLibrary();
        populateTitleSelect();

        const result = document.getElementById('testResult');
        result.innerHTML = '<div class="success">Prompt saved to library!</div>';
        setTimeout(() => result.innerHTML = '', 3000);
    }

    function loadPrompt(id) {
        const prompt = state.library.find(p => p.id === id);
        if (!prompt) return;

        document.getElementById('title').value = prompt.title;
        document.getElementById('role').value = prompt.role;
        document.getElementById('task').value = prompt.task;
        document.getElementById('context').value = prompt.context;

        document.getElementById('constraintsList').innerHTML = '';
        prompt.constraints.forEach(c => {
            addConstraint();
            const inputs = document.querySelectorAll('#constraintsList input');
            inputs[inputs.length - 1].value = c;
        });

        document.getElementById('examplesList').innerHTML = '';
        prompt.examples.forEach(e => {
            addExample();
            const inputs = document.querySelectorAll('#examplesList input');
            inputs[inputs.length - 1].value = e;
        });

        updatePreview();
        const titleSelect = document.getElementById('titleSelect');
        if (titleSelect) {
            titleSelect.value = String(prompt.id);
            titleSelect.dispatchEvent(new Event('change'));
        }
        // ensure other selects are set to custom so inputs remain editable
        const roleSelect = document.getElementById('roleSelect');
        if (roleSelect) roleSelect.value = 'custom';
        const taskSelect = document.getElementById('taskSelect');
        if (taskSelect) taskSelect.value = 'custom';
        const contextSelect = document.getElementById('contextSelect');
        if (contextSelect) contextSelect.value = 'custom';
    }

    function deletePrompt(id) {
        state.library = state.library.filter(p => p.id !== id);
        localStorage.setItem('promptLibrary', JSON.stringify(state.library));
        renderLibrary();
        populateTitleSelect();
    }

    function renderLibrary() {
        const list = document.getElementById('libraryList');
        if (state.library.length === 0) {
            list.innerHTML = '<p style="color: var(--text-tertiary); font-size: 0.875rem;">No saved prompts</p>';
            populateTitleSelect();
            return;
        }

        list.innerHTML = state.library.map(p => `
                <div class="library-item">
                    <div class="library-item-title">${p.title}</div>
                    <div class="library-item-meta">${new Date(p.timestamp).toLocaleDateString()}</div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="loadPrompt(${p.id})">Load</button>
                        <button class="btn btn-secondary" onclick="deletePrompt(${p.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        populateTitleSelect();
    }

    function clearAll() {
        if (!confirm('Clear all fields?')) return;
        document.getElementById('title').value = '';
        document.getElementById('role').value = '';
        document.getElementById('task').value = '';
        document.getElementById('context').value = '';
        document.getElementById('constraintsList').innerHTML = '';
        document.getElementById('examplesList').innerHTML = '';
        const titleSelect = document.getElementById('titleSelect');
        if (titleSelect) {
            titleSelect.value = 'custom';
            document.getElementById('title').disabled = false;
        }
        const roleSelect = document.getElementById('roleSelect');
        if (roleSelect) {
            roleSelect.value = 'custom';
            document.getElementById('role').disabled = false;
        }
        const taskSelect = document.getElementById('taskSelect');
        if (taskSelect) {
            taskSelect.value = 'custom';
            document.getElementById('task').disabled = false;
        }
        const contextSelect = document.getElementById('contextSelect');
        if (contextSelect) {
            contextSelect.value = 'custom';
            document.getElementById('context').disabled = false;
        }
        updatePreview();
    }

    function loadSamplePrompt() {
        document.getElementById('title').value = 'Content Summarization Assistant';
        document.getElementById('role').value = 'Expert content analyst and technical writer';
        document.getElementById('task').value = 'Analyze and summarize long-form content into clear, actionable insights while preserving key information and context';
        document.getElementById('context').value = 'You will receive articles, documentation, or reports that need to be condensed for busy professionals who need to understand the core message quickly';

        document.getElementById('constraintsList').innerHTML = '';
        const sampleConstraints = [
            'Keep summaries under 200 words',
            'Maintain factual accuracy without interpretation',
            'Highlight actionable items separately',
            'Use bullet points for multiple key points'
        ];
        sampleConstraints.forEach(c => {
            addConstraint();
            const inputs = document.querySelectorAll('#constraintsList input');
            inputs[inputs.length - 1].value = c;
        });

        document.getElementById('examplesList').innerHTML = '';
        const sampleExamples = [
            'Input: 5000-word research paper → Output: 150-word summary with 3 key findings',
            'Input: Technical documentation → Output: Executive summary with implementation steps',
            'Input: News article → Output: Brief with main points and implications'
        ];
        sampleExamples.forEach(e => {
            addExample();
            const inputs = document.querySelectorAll('#examplesList input');
            inputs[inputs.length - 1].value = e;
        });

        updatePreview();

        const result = document.getElementById('testResult');
        result.innerHTML = '<div class="success">Sample prompt loaded successfully!</div>';
        setTimeout(() => result.innerHTML = '', 3000);
        const titleSelect = document.getElementById('titleSelect');
        if (titleSelect) {
            titleSelect.value = 'custom';
            document.getElementById('title').disabled = false;
        }
        const roleSelect = document.getElementById('roleSelect');
        if (roleSelect) {
            roleSelect.value = 'custom';
            document.getElementById('role').disabled = false;
        }
        const taskSelect = document.getElementById('taskSelect');
        if (taskSelect) {
            taskSelect.value = 'custom';
            document.getElementById('task').disabled = false;
        }
        const contextSelect = document.getElementById('contextSelect');
        if (contextSelect) {
            contextSelect.value = 'custom';
            document.getElementById('context').disabled = false;
        }
    }

    async function testPrompt() {
        const apiKey = document.getElementById('apiKey').value;
        const model = document.getElementById('modelSelect').value;
        const testInput = document.getElementById('testInput').value;
        const resultDiv = document.getElementById('testResult');

        if (!apiKey) {
            resultDiv.innerHTML = '<div class="error">Please enter your OpenRouter API key</div>';
            return;
        }

        if (!model) {
            resultDiv.innerHTML = '<div class="error">Please select a model</div>';
            return;
        }

        if (!testInput) {
            resultDiv.innerHTML = '<div class="error">Please enter test input</div>';
            return;
        }

        const data = getPromptData();
        let promptText = '';
        if (data.role) promptText += `Role: ${formatRoleForOutput(data.role)}\n`;
        if (data.task) promptText += `Task: ${data.task}\n`;
        if (data.context) promptText += `Context: ${data.context}\n`;
        if (data.constraints.length) {
            promptText += `Constraints: ${data.constraints.join(', ')}\n`;
        }
        promptText += `\nInput: ${testInput}`;

        const temperature = parseFloat(document.getElementById('temperature').value);
        const maxTokens = parseInt(document.getElementById('maxTokens').value);
        const topP = parseFloat(document.getElementById('topP').value);
        const topK = parseInt(document.getElementById('topK').value);
        const frequencyPenalty = parseFloat(document.getElementById('frequencyPenalty').value);
        const presencePenalty = parseFloat(document.getElementById('presencePenalty').value);
        const streamEnabled = document.getElementById('streamEnabled').checked;
        const jsonMode = document.getElementById('jsonMode').checked;

        const requestBody = {
            model: model,
            messages: [{ role: 'user', content: promptText }],
            temperature: temperature,
            max_tokens: maxTokens,
            top_p: topP
        };

        if (topK > 0) requestBody.top_k = topK;
        if (frequencyPenalty !== 0) requestBody.frequency_penalty = frequencyPenalty;
        if (presencePenalty !== 0) requestBody.presence_penalty = presencePenalty;
        if (streamEnabled) requestBody.stream = true;
        if (jsonMode) requestBody.response_format = { type: 'json_object' };

        resultDiv.innerHTML = '<div style="display: flex; align-items: center; gap: 0.5rem;"><div class="loading"></div> Testing with ' + model + '...</div>';

        try {
            if (streamEnabled) {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Structured Prompt Builder'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let output = '';

                resultDiv.innerHTML = `
                        <div style="margin-top: 1rem;">
                            <label class="label">AI Response (Streaming)</label>
                            <div class="editor" style="min-height: 200px;" id="streamOutput"></div>
                        </div>
                    `;

                const streamOutput = document.getElementById('streamOutput');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') break;

                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices?.[0]?.delta?.content || '';
                                output += content;
                                streamOutput.textContent = output;
                            } catch (e) {
                            }
                        }
                    }
                }
            } else {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Structured Prompt Builder'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const result = await response.json();
                const output = result.choices?.[0]?.message?.content || 'No response';
                const usage = result.usage;

                resultDiv.innerHTML = `
                        <div style="margin-top: 1rem;">
                            <label class="label">AI Response</label>
                            <div class="editor" style="min-height: 200px;">${output}</div>
                            ${usage ? `
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-tertiary);">
                                    Tokens: ${usage.prompt_tokens} prompt + ${usage.completion_tokens} completion = ${usage.total_tokens} total
                                </div>
                            ` : ''}
                        </div>
                    `;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        }
    }



    init();
</script>
</body>
</html>
